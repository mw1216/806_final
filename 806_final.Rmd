---
title: "806_final"
author: "Megan Worth"
date: "11/8/2021"
output: pdf_document
editor_options: 
  chunk_output_type: console
---
**Introduction**
  
  Microbial communities are responsible for carrying out crucial ecosystem functions and processes, and are therefore essential to life on Earth (Li et al., 2015). Specifically, in aquatic systems, bacterial communities play vital roles in biogeochemical cycling (Monard et al., 2016). Knowledge of the composition, structure, and distribution of microbial communities can be utilized to predict how an ecosystem may respond to environmental changes over time (Monard et al., 2016; Sieber et al., 2020).
  The North Temperate Lakes Long Term Ecological Research (LTER) program located in Vilas County, Wisconsin has collected a myriad of data from lakes and bogs in the area. In 2007 and 2009, data on pH, dissolved oxygen (DO), and temperature were collected from Crystal Bog. Additionally, samples were collected and analyzed to identify members of the microbial community by 16S rRNA sequencing (McMahon et al., 2019). This dataset was analyzed using R v. 4.1.1 to gain an understanding of the influence these environmental factors (pH, DO, temperature) may have had on microbial community composition between 2007 and 2009.

**Methods**

  Data was collected by researchers through the North Temperate Lakes LTER in Vilas County, Wisconsin. Freshwater samples were collected from Crystal Bog in 2007 and 2009 and 16S rRNA sequencing was performed. Data was analyzed using R v. 4.1.1. The vegan package was used to generate (NMDS or PCoA) ordinations to visualize relatedness of microbial community samples according to (depth, layer, DO, pH, or temperature).
  
**Results**

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE}

sup_data <- read.csv("C:/Users/megan/Desktop/806_final/supp_data1.csv", stringsAsFactors = TRUE)

lake_data <- read.csv("C:/Users/megan/Desktop/806_final/lake_data1.csv", stringsAsFactors = TRUE)

otu_data <- read.csv("C:/Users/megan/Desktop/806_final/otu_data1.csv", stringsAsFactors = TRUE)

rel_abun <- read.csv("C:/Users/megan/Desktop/806_final/rel_abun1.csv", stringsAsFactors = TRUE)

```

```{r, echo = FALSE}
library(dplyr)
library(tidyr)
```

```{r, echo = FALSE}

comb1 <- inner_join(otu_data, rel_abun, by = "OTU")
comb2 <- distinct(inner_join(sup_data, lake_data))
database <- distinct(inner_join(comb1, comb2))


```

# relative abundance of each phlya by pH in 2009
```{r, echo = FALSE}

col_vector <- unname(distinctColorPalette(50))
library(ggplot2)
select(database, Phylum, value, pH, Year) %>%
  filter(Year == 2009, pH > 0) %>% 
  ggplot(mapping = aes(fill = Phylum, x = pH, y = value, color =
  Phylum)) + geom_bar(position="stack", stat="identity") +
  labs(x = "pH", y = "Abundance") +
  theme(legend.text = element_text(size = 6), 
  legend.key.size = unit(0.45, "cm"), 
  legend.key.height = unit(0.45, "cm"),  
  legend.key.width = unit(0.45, "cm")) + scale_color_manual(
    values = col_vector)

```

# working on making a distance matrix 
OTUs as row names, samples as columns
vegdist(database)

```{r, echo = FALSE}
select(database, OTU, Sample_Name, value) -> data
  as.matrix(data,) -> dist_matrix
vegdist(., method = "bray") -> dist_matrix

```

# average temp 2007 vs. 2009
```{r, echo = FALSE}

select(database, Month, Year, Temperature) %>%
  group_by(Year, Month) %>%
  filter(Temperature != "NA", Month == "6" | Month == "7" | Month == "8") %>%
  summarize(mean_temp = mean(Temperature)) %>%
  ggplot(mapping = aes(x = Month, y = mean_temp, color = as.factor(Year),
  group = Year, by = Year)) + geom_point() + geom_line() + labs(color = 
  "Year", x = "Month", y = "Temperature (C)") + scale_color_brewer(palette = "Dark2") + scale_x_continuous(breaks=c(6, 7, 8))

```

# dissolved oxygen 2007 vs. 2009
```{r, echo = FALSE}

select(database, Month, Year, DO) %>%
  group_by(Year, Month) %>%
  filter(DO != "NA") %>%
  summarize(mean_DO = mean(DO)) %>%
  ggplot(mapping = aes(x = Month, y = mean_DO, color = as.factor(Year),
  group = Year, by = Year)) + geom_point() + geom_line() + labs(color = 
  "Year", x = "Month", y = "Dissolved Oxygen") + scale_color_brewer(palette = "Dark2") #+ scale_x_continuous(breaks=c(6, 7, 8))

```

```{r, echo = FALSE}

select(database, Month, Year, Temperature) %>%
  group_by(Year, Month) %>%
  filter(Temperature != "NA", Month == 6 | Month ==
  7 | Month == 8) %>%
  summarize(mean_Temperature = mean(Temperature)) %>%
  ggplot(mapping = aes(x = Month, y = mean_Temperature, color =
  as.factor(Year),
  group = Year, by = Year)) + geom_point() + geom_line() + labs(color = 
  "Year", x = "Month", y = "Temperature (C)") + scale_color_brewer(palette = "Dark2") + scale_x_continuous(breaks=c(6, 7, 8))

```

```{r, echo = FALSE}

select(database, Month, Year, DO) %>%
  group_by(Year, Month) %>%
  filter(DO != "NA", Month == 6 | Month ==
  7 | Month == 8) %>%
  summarize(mean_DO = mean(DO)) %>%
  ggplot(mapping = aes(x = Month, y = mean_DO, color =
  as.factor(Year),
  group = Year, by = Year)) + geom_point() + geom_line() + labs(color = 
  "Year", x = "Month", y = "Dissolved Oxygen") + scale_color_brewer(palette = "Dark2") + scale_x_continuous(breaks=c(6, 7, 8))

```

```{r, echo = FALSE}

select(database, Month, Year, pH) %>%
  group_by(Year, Month) %>%
  filter(pH != "NA", Month == 6 | Month ==
  7 | Month == 8) %>%
  summarize(mean_pH = mean(pH)) %>%
  ggplot(mapping = aes(x = Month, y = mean_pH, color =
  as.factor(Year),
  group = Year, by = Year)) + geom_point() + geom_line() + labs(color = 
  "Year", x = "Month", y = "pH") + scale_color_brewer(palette = "Dark2") + scale_x_continuous(breaks=c(6, 7, 8))

```

# depth vs. dissolved oxygen measured - needs work (only set to show June 2009)
```{r, echo = FALSE}

select(database, Depth, DO, Month, Year) %>%
  filter(DO != "NA", Depth != "NA", Month == "6", Year == "2009") %>%
  ggplot(mapping = aes(x = Depth, y = DO)) + geom_point() + geom_line() + labs(x = "Depth", y = "Dissolved Oxygen")

```

# this plot shows abundance of microbes by varying pH, only for 2009 (limited pH data for 2007)
```{r, echo = FALSE}

select(database, Phylum, value, pH, Year) %>%
  filter(Year == 2009, value > 100, pH != "NA") %>%
  group_by(pH, Phylum) %>%
  summarize(value=sum(value)) %>%
  ggplot(mapping = aes(fill = Phylum, x = pH, y =
  value, color = Phylum)) + geom_bar(position = 
  "stack", stat="identity") + labs(x="pH", y="Abundance")

```

```{r, echo = FALSE}

select(database, Phylum, value, Month, Year, Temperature) %>%
  filter(Year == 2009, value > 100, Temperature != "NA") %>%
  group_by(Month, Phylum) %>%
  summarize(value=sum(value)) %>%
  ggplot(mapping = aes(fill = Phylum, x = Month, y =
  value, color = Phylum)) + geom_bar(position = 
  "stack", stat="identity") + labs(x="Month", y = "Abundance") 

```

```{r, echo = FALSE}

select(database, Phylum, value, Year, Depth) %>%
  filter(Year == 2009, value > 1, Depth != "NA") %>%
  group_by(Depth, Phylum) %>%
  summarize(value=sum(value)) %>%
  ggplot(mapping = aes(fill = Phylum, x = Depth, y =
  value, color = Phylum)) + geom_bar(position = 
  "stack", stat="identity") + labs(x = "Depth (m)", y = "Abundance") +   
  scale_x_continuous(breaks=c(0,0.5,1,1.5,2,2.5)) +
  scale_color_manual(values = col_vector)

```

# Comparison of relative abundances between lake layers in 2009 - needs work
```{r, echo = FALSE}

select(database, Phylum, value, Layer, Year) %>%
  filter(Year == 2009, value > 100) %>%
  group_by(Layer, Phylum) %>%
  summarize(value=sum(value)) %>%
  ggplot(mapping = aes(fill = Phylum, x = Layer, y =
  value, color = Phylum)) + geom_bar(position = 
  "stack", stat="identity") + geom_text(aes(label = Phylum),
  size = 3, color = "black", position = position_stack(vjust = 0.5)) +
  labs(x = "Layer", y = "Abundance") +
  theme(legend.text = element_text(size = 6), 
  legend.key.size = unit(0.35, "cm"), 
  legend.key.height = unit(0.35, "cm"),  
  legend.key.width = unit(0.35, "cm")) 

```

```{r, echo = FALSE}

select(database, Phylum, value, Year) %>%
  filter(value > 100) %>%
  group_by(Year, Phylum) %>%
  summarize(value=sum(value)) %>%
  ggplot(mapping = aes(fill = Phylum, x = Year, y =
  value, color = Phylum)) + geom_bar(position = 
  "stack", stat="identity") +
  labs(x = "Year", y = "Abundance") +
  theme(legend.text = element_text(size = 6), 
  legend.key.size = unit(0.35, "cm"), 
  legend.key.height = unit(0.35, "cm"),  
  legend.key.width = unit(0.35, "cm")) + 
  scale_x_continuous(breaks=c(2007, 2009))
```

```{r, echo = FALSE}

select(database, Phylum, value, Layer, Year, Depth) %>%
  filter(Year == 2009, value > 200) %>%
  ggplot(mapping = aes(x = Phylum, y = value, color = Phylum)) + geom_bar(stat="identity")

```

```{r, echo = FALSE}
library(dplyr)
library(data.table)
library(plotly)

df <- database
a <- list(text = sprintf("Epilimnion"),
          font = list(size = 14),
          yanchor = "bottom",
          xancher = "center",
          align = "center",
          x = 0.5,
          y = 1,
          showarrow = FALSE)
b <- list(text = sprintf("Hypolimnion"),
          font = list(size = 14),
          yanchor = "bottom",
          xanchor = "center",
          align = "center",
          x = 0.5,
          y = 1, 
          showarrow = FALSE)

p1 <- df %>%
  mutate(Phylum = fct_reorder(Phylum, value, .fun = "mean", .desc = T)) %>%
  group_by(Phylum) %>%
  filter(Layer == "Epilimnion") %>%
  plot_ly(x = ~Layer,
          y = ~value,
          color = ~Phylum,
          colors = "Paired",
          type = "bar",
          legendgroup = ~Phylum,
          showlegend = T) %>%
  layout(barmode = "stack", legend = list(title = list(text = "Phylum")), 
         annotations = a, xaxis = list(autorange = "reversed"))

p2 <- df %>%
  mutate(Phylum = fct_reorder(Phylum, value, .fun = "mean", .desc = T)) %>%
  group_by(Phylum) %>%
  filter(Layer == "Hypolimnion") %>%
  plot_ly(x = ~Layer,
          y = ~value,
          color = ~Phylum,
          colors = "Paired",
          type = "bar",
          legendgroup = ~Phylum,
          showlegend = T) %>%
  plotly::layout(barmode = "stack", legend = list(title =
      list(text = "Phylum")), annotations = b, xaxis = list(
      autorange = "reversed"))

p <- subplot(nrows = 1, p1, p2, titleX = T, titleY = T, 
             shareX = T, shareY = T, margin = 0.05)
          
```
# Need to decrease current number of figures / create ordinations (more relevant to explain questions)

**Discussion**



**References**

Li P, Yang SF, Lv BB, Zhao K, Lin MF, Zhou S, Song X, Tang XM. 2015. Comparison of extraction methods of total microbial DNA from freshwater. Genet Mol Res. 14(1):730-8.

Monard, C., Gantner, S., Bertilsson, S., Hallin, S., & Stenlid, J. 2016. Habitat generalists and specialists in microbial communities across a terrestrial-freshwater gradient. Scientific reports, 6, 37719.

Sieber, G., Beisser, D., Bock, C., & Boenigk, J. 2020. Protistan and fungal diversity in soils and freshwater lakes are substantially different. Scientific reports, 10(1), 20025.

McMahon, K., S. Jones, A. Shade, R. Newton, E. Read, L. Beversdorf, R. Rohwer, B. Peterson, A. Linz, E. McDaniel, 	G. 	Wolf, and S. Schmitz. 2019. Microbial Observatory at North Temperate Lakes LTER High-resolution temporal and 	spatial dynamics of microbial community structure in freshwater bog lakes 2005 - 2009 original format ver 4. 	Environmental Data Initiative.
